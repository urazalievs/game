(()=>{const e=document.getElementById("gameBtn");let t,n,a=1e3;function o(e){let t=e.target;a=+t.innerHTML,document.querySelector(".point.activ").classList.remove("activ"),t.classList.add("activ"),console.log(a)}async function r(t){let a=t.target,o=+a.getAttribute("data-row"),r=+a.getAttribute("data-column");try{let t=await c("game_step","POST",{game_id:n,row:o,column:r});console.log(t),function(e){let t=document.querySelectorAll(".field"),n=0;for(let a=0;a<e.length;a++){let o=e[a];for(let e=0;e<o.length;e++){let a=o[e],r=t[n];""==a||(0===a?r.classList.remove("activ"):"BOMB"==a?(r.classList.remove("activ"),r.classList.add("bomb")):a>0&&(r.classList.remove("activ"),r.innerHTML=a)),n++}}}(t.table),t.error?alert(t.message):"Ok"==t.status||("Failed"==t.status?(alert("вы проиграли!"),e.innerHTML="ИГРАТЬ",e.style.backgroundColor="#66a663",setTimeout((()=>l()),2e3)):"Won"==t.status&&(alert("вы выйгали!"),i()))}catch(e){console.error(`Неправильный номер ${e}`)}}function s(e){e.preventDefault();let t=e.target;t.classList.toggle("flag"),console.log(t)}function l(){const e=document.querySelector(".gameField");e.innerHTML="";for(let t=0;t<80;t++){let t=document.createElement("div");t.classList.add("field"),e.appendChild(t)}}async function i(){let e=await c("user","GET",{username:t});console.log(e),e.error?alert(e.message):document.querySelector("header span").innerHTML=`Пользователь ${e.username} с балансом ${e.balance}`}async function c(e,t,n){if(e=`https://tg-api.tehnikum.school/tehnikum_course/minesweeper/${e}`,"POST"==t){let t=await fetch(e,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(n)});return t=await t.json(),t}if("GET"==t){e=e+"?"+new URLSearchParams(n);let t=await fetch(e,{method:"GET",headers:{Accept:"application/json","Content-Type":"application/json"}});return t=await t.json(),t}}e.addEventListener("click",(function(){"ИГРАТЬ"==e.innerHTML?(e.innerHTML="Завершить игру",e.style.backgroundColor="red",async function(){let o=await c("new_game","POST",{username:t,points:a});o.error?(e.innerHTML="ИГРАТЬ",alert(o.message)):(n=o.game_id,i(),console.log(n),function(){const e=document.getElementsByClassName("field");for(let t=0;t<e.length;t++){e[t].addEventListener("contextmenu",s),setInterval((()=>{e[t].classList.add("activ")}),20*t);let n=Math.trunc(t/10),a=t-10*n;e[t].setAttribute("data-row",n),e[t].setAttribute("data-column",a),e[t].addEventListener("click",r)}}())}()):(e.innerHTML="ИГРАТЬ",e.style.backgroundColor="#66a663",async function(){let a=await c("stop_game","POST",{username:t,game_id:n});a.error?(e.innerHTML="Завершить игру",alert(a.message)):(i(),l())}())})),document.querySelector("#loginWrapper form").addEventListener("submit",(e=>{e.preventDefault(),async function(){const e=document.getElementById("loginWrapper"),n=document.getElementById("login").value;let a=await c("user","GET",{username:n});if(console.log(a),a.error){let a=await c("user","POST",{username:n});a.error?alert(a.message):(t=n,e.style.display="none",i())}else t=n,e.style.display="none",i()}()})),[...document.getElementsByClassName("point")].forEach((e=>{e.addEventListener("click",o)})),l()})();